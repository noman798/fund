#! /usr/bin/env coffee
wapi = require("./_wapi.coffee")
fs = require('fs')

_rule = (func)->
    wapi.get(
        ".settings/rules", (error, res, body)->
            func JSON.stringify(
                JSON.parse(body)
                null
                4
            )
    )

yargs = require('yargs')
argv = yargs
.command(
    'rulepush',
    '上传安全规则',
    ->
        rule = require("#{process.cwd()}/wdog_rules.coffee")
        wapi.put(
            ".settings/rules"
            JSON.stringify(rule, null, 4)
            (error, res, body)->
                console.log body
        )
        0
)
.command(
    'rulepull',
    '下载安全规则',
    ->
        _rule (o) ->
            fs.open(
                "#{process.cwd()}//wdog_rules.coffee"
                "w"
                (e,fd) ->
                    if e
                        throw e
                    fs.write(
                        fd
                        "module.exports = \\\n" + o
                        0,'utf8'
                        (e)->
                            if e
                                throw e
                            fs.closeSync(fd)
                    )
            )
            
        0
)
.command(
    'rule',
    '显示安全规则',
    ->
        _rule (o) ->
            console.log o
        0
)
.help('h')
.alias('h', 'help')
.recommendCommands()
.argv

if not argv._.length
    yargs.showHelp()
